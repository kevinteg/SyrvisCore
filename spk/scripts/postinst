#!/bin/sh
# postinst - Phase 1: Basic Installation (No Configuration)
# POSIX shell compatible

set -e

SCRIPT_NAME="postinst"
LOG_FILE="/tmp/syrviscore-install.log"

log_msg() {
    LEVEL="$1"
    MSG="$2"
    TIMESTAMP=$(date '+%Y-%m-%d %H:%M:%S')
    LOG_LINE="[$LEVEL] [$TIMESTAMP] [$SCRIPT_NAME] $MSG"
    
    if [ "$LEVEL" = "ERROR" ]; then
        echo "$LOG_LINE" >&2
    else
        echo "$LOG_LINE"
    fi
    
    echo "$LOG_LINE" >> "$LOG_FILE" 2>/dev/null || true
}

log_info() {
    log_msg "INFO" "$1"
}

log_error() {
    log_msg "ERROR" "$1"
}

PACKAGE_NAME="syrviscore"
SYNOPKG_PKGDEST="${SYNOPKG_PKGDEST:-/var/packages/${PACKAGE_NAME}/target}"

# Use SYNOPKG_PKGDEST as install location (we have permissions there)
# Later, setup command can move/symlink to /volume1/docker if needed
INSTALL_DIR="${SYNOPKG_PKGDEST}"

log_info "==================================================================="
log_info "Starting SyrvisCore installation (Phase 1)"
log_info "==================================================================="
log_info "Installation directory: ${INSTALL_DIR}"
log_info ""

# === Create directory structure ===
log_info "[1/5] Creating directory structure..."
mkdir -p "${INSTALL_DIR}/data/traefik/config"
mkdir -p "${INSTALL_DIR}/data/traefik/logs"
mkdir -p "${INSTALL_DIR}/data/portainer"
mkdir -p "${INSTALL_DIR}/data/cloudflared"
mkdir -p "${INSTALL_DIR}/cli"
mkdir -p "${INSTALL_DIR}/bin"
mkdir -p "${INSTALL_DIR}/versions"

# === Install Python CLI ===
log_info "[2/5] Installing Python CLI..."

# Search for wheel file (DSM extracts package.tgz automatically to SYNOPKG_PKGDEST)
log_info "  Searching for wheel file in: ${SYNOPKG_PKGDEST}"
WHEEL_FILE=$(ls "${SYNOPKG_PKGDEST}"/syrviscore-*.whl 2>/dev/null | head -1)

if [ -z "$WHEEL_FILE" ]; then
    # Try package subdirectory as fallback
    log_info "  Not found, trying: ${SYNOPKG_PKGDEST}/package"
    WHEEL_FILE=$(ls "${SYNOPKG_PKGDEST}/package"/syrviscore-*.whl 2>/dev/null | head -1)
fi

if [ -z "$WHEEL_FILE" ]; then
    log_error "  Wheel file not found"
    log_error "  Debug: Contents of ${SYNOPKG_PKGDEST}:"
    ls -la "${SYNOPKG_PKGDEST}" >> "$LOG_FILE" 2>&1
    exit 1
fi

log_info "  Found wheel: $(basename "$WHEEL_FILE")"

cd "${INSTALL_DIR}/cli"
python3 -m venv venv
. venv/bin/activate
pip install --upgrade pip > /dev/null 2>&1

log_info "  Installing Python CLI..."
pip install --no-cache-dir "$WHEEL_FILE" > /dev/null 2>&1
log_info "  Python CLI installed successfully"

deactivate

# === Verify templates ===
log_info "[3/5] Verifying configuration templates..."

# Note: DSM extracts package.tgz directly to SYNOPKG_PKGDEST
# Since INSTALL_DIR = SYNOPKG_PKGDEST, files are already in place

# Verify build config exists (optional)
if [ -d "${INSTALL_DIR}/build" ]; then
    log_info "  Found build configuration"
else
    log_info "  No build config found (will be generated by CLI)"
fi

# Verify .env.template exists (required)
if [ -f "${INSTALL_DIR}/.env.template" ]; then
    log_info "  Found .env.template"
else
    log_error "  .env.template not found in ${INSTALL_DIR}"
    log_error "  Debug: Listing files in ${INSTALL_DIR}:"
    ls -la "${INSTALL_DIR}" >> "$LOG_FILE" 2>&1
    exit 1
fi

# === Create acme.json ===
log_info "[4/5] Creating SSL certificate storage..."
log_info "  Creating ${INSTALL_DIR}/data/traefik/acme.json"
touch "${INSTALL_DIR}/data/traefik/acme.json" || {
    log_error "  Failed to create acme.json"
    exit 1
}
chmod 600 "${INSTALL_DIR}/data/traefik/acme.json" || {
    log_error "  Failed to set acme.json permissions"
    exit 1
}
log_info "  Created acme.json with secure permissions (600)"

# === Create CLI wrapper ===
log_info "[5/5] Creating CLI wrapper..."
log_info "  Writing wrapper script to ${INSTALL_DIR}/bin/syrvis"
cat > "${INSTALL_DIR}/bin/syrvis" << 'CLI_WRAPPER_EOF'
#!/bin/sh
# SyrvisCore CLI Wrapper
SCRIPT_DIR="$(cd "$(dirname "$0")" && pwd)"
INSTALL_DIR="$(dirname "${SCRIPT_DIR}")"
export SYRVIS_HOME="${INSTALL_DIR}"
exec "${INSTALL_DIR}/cli/venv/bin/syrvis" "$@"
CLI_WRAPPER_EOF

if [ ! -f "${INSTALL_DIR}/bin/syrvis" ]; then
    log_error "  Failed to create CLI wrapper"
    exit 1
fi

chmod +x "${INSTALL_DIR}/bin/syrvis" || {
    log_error "  Failed to set wrapper permissions"
    exit 1
}
log_info "  Created CLI wrapper with execute permissions"

# === Create manifest ===
PKG_VERSION=$(grep '^version=' "${SYNOPKG_PKGDEST}/../INFO" | cut -d'"' -f2)
cat > "${INSTALL_DIR}/.syrviscore-manifest.json" << MANIFEST_EOF
{
    "version": "${PKG_VERSION}",
    "install_date": "$(date -u +%Y-%m-%dT%H:%M:%SZ)",
    "install_dir": "${INSTALL_DIR}",
    "install_volume": "/volume1",
    "setup_complete": false,
    "python_version": "$(python3 --version 2>&1 | awk '{print $2}')"
}
MANIFEST_EOF
chmod 644 "${INSTALL_DIR}/.syrviscore-manifest.json"
log_info "  Created installation manifest"

log_info ""
log_info "==================================================================="
log_info "SyrvisCore Installation Complete (Phase 1 of 2)"
log_info "==================================================================="
log_info ""
log_info "NEXT STEP: Configure and enable SyrvisCore"
log_info ""
log_info "Run this command to complete setup:"
log_info "  sudo ${INSTALL_DIR}/bin/syrvis setup --interactive"
log_info ""
log_info "Or provide configuration via command line:"
log_info "  sudo ${INSTALL_DIR}/bin/syrvis setup --domain example.com --subnet 192.168.1.0/24 \\"
log_info "                    --gateway 192.168.1.1 --traefik-ip 192.168.1.4 \\"
log_info "                    --email admin@example.com"
log_info ""
log_info "After setup, verify with:"
log_info "  ${INSTALL_DIR}/bin/syrvis doctor"
log_info ""
log_info "Documentation: https://github.com/kevinteg/SyrvisCore"
log_info "==================================================================="
log_info "Detailed logs: $LOG_FILE"

exit 0
