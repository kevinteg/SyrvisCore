#!/bin/sh
# postinst - Phase 1 unprivileged installation
# POSIX shell compatible (no bashisms)

set -e

PACKAGE_NAME="syrviscore"
SYNOPKG_PKGDEST="/var/packages/${PACKAGE_NAME}/target"

# Get installation volume from wizard (defaults to volume1)
INSTALL_VOLUME="${pkgwizard_volume:-/volume1}"
INSTALL_DIR="${INSTALL_VOLUME}/docker/${PACKAGE_NAME}"

echo "Installing SyrvisCore to: ${INSTALL_DIR}"

# === SECTION 1: Create directory structure ===
mkdir -p "${INSTALL_DIR}/data/traefik/config"
mkdir -p "${INSTALL_DIR}/data/traefik/logs"
mkdir -p "${INSTALL_DIR}/data/portainer"
mkdir -p "${INSTALL_DIR}/data/cloudflared"
mkdir -p "${INSTALL_DIR}/cli"
mkdir -p "${INSTALL_DIR}/bin"
mkdir -p "${INSTALL_DIR}/versions"

# === SECTION 2: Install Python CLI ===
cd "${INSTALL_DIR}/cli"
python3 -m venv venv
. venv/bin/activate
pip install --upgrade pip > /dev/null 2>&1
pip install --no-cache-dir "${SYNOPKG_PKGDEST}/package"/syrviscore-*.whl > /dev/null 2>&1
deactivate

# === SECTION 3: Copy build configuration ===
cp -r "${SYNOPKG_PKGDEST}/package/build" "${INSTALL_DIR}/"
cp "${SYNOPKG_PKGDEST}/package/.env.template" "${INSTALL_DIR}/"

# === SECTION 4: Generate .env from wizard ===
cat > "${INSTALL_DIR}/.env" << ENV_EOF
# SyrvisCore Configuration (generated during installation)

# Installation
SYRVISCORE_INSTALL_DIR=${INSTALL_DIR}
SYRVISCORE_DATA_DIR=${INSTALL_DIR}/data

# Network (macvlan)
NETWORK_INTERFACE=${pkgwizard_network_interface:-ovs_eth0}
NETWORK_SUBNET=${pkgwizard_network_subnet}
GATEWAY_IP=${pkgwizard_gateway_ip}
TRAEFIK_IP=${pkgwizard_traefik_ip}

# Domain & SSL
DOMAIN=${pkgwizard_domain}
ACME_EMAIL=${pkgwizard_acme_email}

# Cloudflare Tunnel (optional)
CLOUDFLARE_TUNNEL_TOKEN=${pkgwizard_cloudflare_token:-}

# Traefik
TRAEFIK_LOG_LEVEL=INFO
TRAEFIK_API_DASHBOARD=true

# Portainer
PORTAINER_BIND_PORT=9443

# System
TZ=$(cat /etc/TZ 2>/dev/null || echo "UTC")
ENV_EOF
chmod 600 "${INSTALL_DIR}/.env"

# === SECTION 5: Create acme.json with strict permissions ===
touch "${INSTALL_DIR}/data/traefik/acme.json"
chmod 600 "${INSTALL_DIR}/data/traefik/acme.json"

# === SECTION 6: Create CLI wrapper ===
cat > "${INSTALL_DIR}/bin/syrvis" << 'CLI_WRAPPER_EOF'
#!/bin/sh
# SyrvisCore CLI Wrapper
SCRIPT_DIR="$(cd "$(dirname "$0")" && pwd)"
INSTALL_DIR="$(dirname "${SCRIPT_DIR}")"
export SYRVIS_HOME="${INSTALL_DIR}"
exec "${INSTALL_DIR}/cli/venv/bin/syrvis" "$@"
CLI_WRAPPER_EOF
chmod +x "${INSTALL_DIR}/bin/syrvis"

# === SECTION 7: Create manifest ===
PKG_VERSION=$(grep '^version=' "${SYNOPKG_PKGDEST}/../INFO" | cut -d'"' -f2)
cat > "${INSTALL_DIR}/.syrviscore-manifest.json" << MANIFEST_EOF
{
    "version": "${PKG_VERSION}",
    "install_date": "$(date -u +%Y-%m-%dT%H:%M:%SZ)",
    "install_dir": "${INSTALL_DIR}",
    "install_volume": "${INSTALL_VOLUME}",
    "setup_complete": false,
    "network": {
        "interface": "${pkgwizard_network_interface:-ovs_eth0}",
        "subnet": "${pkgwizard_network_subnet}",
        "gateway": "${pkgwizard_gateway_ip}",
        "traefik_ip": "${pkgwizard_traefik_ip}"
    },
    "domain": "${pkgwizard_domain}",
    "python_version": "$(python3 --version 2>&1 | awk '{print $2}')"
}
MANIFEST_EOF
chmod 644 "${INSTALL_DIR}/.syrviscore-manifest.json"

# === SECTION 8: Copy privileged setup script ===
cp "${SYNOPKG_PKGDEST}/package/bin/setup-privileges.py" "${INSTALL_DIR}/bin/"
chmod +x "${INSTALL_DIR}/bin/setup-privileges.py"

# === SECTION 9: Generate Task Scheduler template ===
cat > "${INSTALL_DIR}/bin/syrviscore-task-template.json" << 'TASK_TEMPLATE_EOF'
{
  "name": "SyrvisCore - Docker Permissions Setup",
  "owner": {
    "0": {
      "group": "root",
      "user": "root"
    }
  },
  "enable": true,
  "schedule": {
    "date_type": 0,
    "repeat_date": "0",
    "repeat_hour": "0",
    "repeat_min": "0"
  },
  "script": "python3 ${INSTALL_DIR}/bin/setup-privileges.py",
  "extra": {
    "notify_enable": false,
    "notify_mail": "",
    "notify_if_error": false
  },
  "type": "boot"
}
TASK_TEMPLATE_EOF
# Replace ${INSTALL_DIR} with actual path
sed -i "s|\${INSTALL_DIR}|${INSTALL_DIR}|g" "${INSTALL_DIR}/bin/syrviscore-task-template.json"

echo ""
echo "===================================================================="
echo "  SyrvisCore Installation Complete (Phase 1 of 2)"
echo "===================================================================="
echo ""
echo "NEXT STEP REQUIRED: Configure Docker permissions"
echo ""
echo "Option 1 - Manual setup (recommended for first-time):"
echo "  sudo python3 ${INSTALL_DIR}/bin/setup-privileges.py"
echo ""
echo "Option 2 - Import into Task Scheduler (for boot persistence):"
echo "  1. Open DSM Control Panel > Task Scheduler"
echo "  2. Create > Scheduled Task > User-defined script"
echo "  3. General: Name: 'SyrvisCore Setup', User: root"
echo "  4. Schedule: Run on boot"
echo "  5. Task Settings: User-defined script:"
echo "     python3 ${INSTALL_DIR}/bin/setup-privileges.py"
echo "  6. Click OK, then right-click task > Run"
echo ""
echo "After running setup, log out and back in, then verify:"
echo "  ${INSTALL_DIR}/bin/syrvis doctor"
echo ""
echo "===================================================================="
echo ""

exit 0