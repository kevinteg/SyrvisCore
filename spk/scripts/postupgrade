#!/bin/sh
# postupgrade - Upgrade SyrvisCore Manager
# POSIX shell compatible
#
# This script upgrades the MANAGER package only.
# Service versions are managed separately via 'syrvisctl'.
#
# All dependencies are bundled in the SPK - NO NETWORK ACCESS REQUIRED.
#
# DEBUGGING:
#   - All output is logged to: /tmp/syrviscore-install.log
#   - View logs: cat /tmp/syrviscore-install.log
#   - Tail logs: tail -f /tmp/syrviscore-install.log

set -e

SCRIPT_NAME="postupgrade"
LOG_FILE="/tmp/syrviscore-install.log"
PIP_LOG_FILE="/tmp/syrviscore-pip.log"

# Initialize log file with header
echo "" >> "$LOG_FILE" 2>/dev/null || true
echo "========================================" >> "$LOG_FILE" 2>/dev/null || true
echo "SyrvisCore Upgrade Log" >> "$LOG_FILE" 2>/dev/null || true
echo "Started: $(date '+%Y-%m-%d %H:%M:%S')" >> "$LOG_FILE" 2>/dev/null || true
echo "========================================" >> "$LOG_FILE" 2>/dev/null || true

log_msg() {
    LEVEL="$1"
    MSG="$2"
    TIMESTAMP=$(date '+%Y-%m-%d %H:%M:%S')
    LOG_LINE="[$LEVEL] [$TIMESTAMP] [$SCRIPT_NAME] $MSG"

    if [ "$LEVEL" = "ERROR" ]; then
        echo "$LOG_LINE" >&2
    else
        echo "$LOG_LINE"
    fi

    echo "$LOG_LINE" >> "$LOG_FILE" 2>/dev/null || true
}

log_info() {
    log_msg "INFO" "$1"
}

log_error() {
    log_msg "ERROR" "$1"
}

# Function to show debug instructions on failure
show_debug_help() {
    echo "" >&2
    echo "==================================================================" >&2
    echo "UPGRADE FAILED - DEBUG INFORMATION" >&2
    echo "==================================================================" >&2
    echo "" >&2
    echo "To diagnose the issue, check the log files:" >&2
    echo "" >&2
    echo "  1. Main installation log:" >&2
    echo "     cat /tmp/syrviscore-install.log" >&2
    echo "" >&2
    echo "  2. Pip installation log (if pip failed):" >&2
    echo "     cat /tmp/syrviscore-pip.log" >&2
    echo "" >&2
    echo "  3. View last 50 lines of main log:" >&2
    echo "     tail -50 /tmp/syrviscore-install.log" >&2
    echo "" >&2
    echo "Report issues: https://github.com/kevinteg/SyrvisCore/issues" >&2
    echo "==================================================================" >&2
}

PACKAGE_NAME="syrviscore"
SYNOPKG_PKGDEST="${SYNOPKG_PKGDEST:-/var/packages/${PACKAGE_NAME}/target}"

# Trap errors to show debug help
trap 'show_debug_help' ERR

log_info "==================================================================="
log_info "Upgrading SyrvisCore Manager"
log_info "==================================================================="
log_info "Target directory: ${SYNOPKG_PKGDEST}"
log_info "Log file: ${LOG_FILE}"
log_info "Pip log: ${PIP_LOG_FILE}"
log_info ""

# Log system information for debugging
log_info "System Information:"
log_info "  Hostname: $(hostname 2>/dev/null || echo 'unknown')"
log_info "  User: $(whoami)"
log_info "  UID: $(id -u)"
log_info "  Python: $(python3 --version 2>&1 || echo 'not found')"
log_info ""

# === Upgrade manager virtual environment ===
log_info "[1/3] Upgrading manager virtual environment..."

MANAGER_VENV="${SYNOPKG_PKGDEST}/venv"

# Remove old venv
if [ -d "$MANAGER_VENV" ]; then
    rm -rf "$MANAGER_VENV"
    log_info "  Removed old venv"
fi

# Create new venv
python3 -m venv "$MANAGER_VENV"
log_info "  Created new venv"

# === Install manager package from bundled wheels ===
log_info "[2/3] Installing manager package (offline from bundled wheels)..."

# Find wheels directory
WHEELS_DIR="${SYNOPKG_PKGDEST}/wheels"

if [ ! -d "$WHEELS_DIR" ]; then
    log_error "Wheels directory not found: $WHEELS_DIR"
    exit 1
fi

WHEEL_COUNT=$(ls -1 "${WHEELS_DIR}"/*.whl 2>/dev/null | wc -l | tr -d ' ')
log_info "  Found $WHEEL_COUNT bundled wheel(s)"

# Find the manager wheel specifically
MANAGER_WHEEL=$(ls "${WHEELS_DIR}"/syrviscore_manager-*.whl 2>/dev/null | head -1)

if [ -z "$MANAGER_WHEEL" ]; then
    log_error "Manager wheel not found in wheels directory"
    exit 1
fi

log_info "  Manager wheel: $(basename "$MANAGER_WHEEL")"

# Install manager and dependencies from bundled wheels
# In production (Synology): --no-index ensures offline installation
# In simulation (macOS): Allow network for platform-specific wheels
log_info "  Installing pip packages (output logged to $PIP_LOG_FILE)..."

# Clear pip log for this installation
echo "=== Pip Upgrade Log ===" > "$PIP_LOG_FILE" 2>/dev/null || true
echo "Started: $(date '+%Y-%m-%d %H:%M:%S')" >> "$PIP_LOG_FILE" 2>/dev/null || true
echo "Wheel: $MANAGER_WHEEL" >> "$PIP_LOG_FILE" 2>/dev/null || true
echo "Wheels dir: $WHEELS_DIR" >> "$PIP_LOG_FILE" 2>/dev/null || true
echo "============================" >> "$PIP_LOG_FILE" 2>/dev/null || true

if [ "${DSM_SIM_ACTIVE:-0}" = "1" ]; then
    # Simulation mode: use bundled wheels but allow network for platform-specific deps
    log_info "  (Simulation mode: allowing network for platform-specific wheels)"
    if ! "${MANAGER_VENV}/bin/pip" install \
        --no-cache-dir \
        --find-links "$WHEELS_DIR" \
        "$MANAGER_WHEEL" >> "$PIP_LOG_FILE" 2>&1; then
        log_error "Pip install failed! Check $PIP_LOG_FILE for details"
        log_error "Last 20 lines of pip log:"
        tail -20 "$PIP_LOG_FILE" >> "$LOG_FILE" 2>/dev/null || true
        tail -20 "$PIP_LOG_FILE" >&2
        exit 1
    fi
else
    # Production mode: fully offline installation
    if ! "${MANAGER_VENV}/bin/pip" install \
        --no-cache-dir \
        --no-index \
        --find-links "$WHEELS_DIR" \
        "$MANAGER_WHEEL" >> "$PIP_LOG_FILE" 2>&1; then
        log_error "Pip install failed! Check $PIP_LOG_FILE for details"
        log_error "Last 20 lines of pip log:"
        tail -20 "$PIP_LOG_FILE" >> "$LOG_FILE" 2>/dev/null || true
        tail -20 "$PIP_LOG_FILE" >&2
        exit 1
    fi
fi

log_info "  Manager package and dependencies installed successfully"

# Verify installation
if [ ! -f "${MANAGER_VENV}/bin/syrvisctl" ]; then
    log_error "syrvisctl command not found after install"
    log_error "Expected location: ${MANAGER_VENV}/bin/syrvisctl"
    log_error "Contents of ${MANAGER_VENV}/bin/:"
    ls -la "${MANAGER_VENV}/bin/" >> "$LOG_FILE" 2>&1
    ls -la "${MANAGER_VENV}/bin/" >&2
    exit 1
fi

# Test that syrvisctl actually works
if ! "${MANAGER_VENV}/bin/syrvisctl" --version >> "$LOG_FILE" 2>&1; then
    log_error "syrvisctl command found but failed to execute"
    exit 1
fi

SYRVISCTL_VERSION=$("${MANAGER_VENV}/bin/syrvisctl" --version 2>/dev/null || echo "unknown")
log_info "  Verified: syrvisctl command available (${SYRVISCTL_VERSION})"

# === Update PATH configuration ===
log_info "[3/3] Updating command access configuration..."

# The syrvisctl command is available at a deterministic path
SYRVISCTL_CMD="${MANAGER_VENV}/bin/syrvisctl"
log_info "  Command location: ${SYRVISCTL_CMD}"

# Update the shell profile snippet
PROFILE_SNIPPET="${SYNOPKG_PKGDEST}/syrviscore.profile"
cat > "$PROFILE_SNIPPET" << EOF
# SyrvisCore PATH configuration
# Source this file to add syrvisctl to your PATH:
#   source ${SYNOPKG_PKGDEST}/syrviscore.profile
export PATH="\${PATH}:${MANAGER_VENV}/bin"
EOF

log_info "  Profile snippet: ${PROFILE_SNIPPET}"

log_info ""
log_info "==================================================================="
log_info "SyrvisCore Manager Upgrade Complete"
log_info "==================================================================="
log_info ""
log_info "The manager has been upgraded to version ${SYRVISCTL_VERSION}."
log_info ""
log_info "Service versions are not affected by this upgrade."
log_info ""
log_info "If syrvisctl is not in your PATH, source the profile:"
log_info "  source ${PROFILE_SNIPPET}"
log_info ""
log_info "To update the service package, run:"
log_info "  syrvisctl install"
log_info ""
log_info "==================================================================="
log_info "Detailed logs: $LOG_FILE"

exit 0
