#!/bin/sh
# postupgrade - Phase 1 unprivileged upgrade
# POSIX shell compatible

set -e

PACKAGE_NAME="syrviscore"
SYNOPKG_PKGDEST="/var/packages/${PACKAGE_NAME}/target"

# Detect installation directory
INSTALL_DIR=""
for VOLUME in /volume1 /volume2 /volume3 /volume4 /volume5; do
    if [ -f "${VOLUME}/docker/${PACKAGE_NAME}/.syrviscore-manifest.json" ]; then
        INSTALL_DIR="${VOLUME}/docker/${PACKAGE_NAME}"
        break
    fi
done

if [ -z "$INSTALL_DIR" ]; then
    echo "ERROR: Could not find existing installation"
    exit 1
fi

echo "Upgrading SyrvisCore at: ${INSTALL_DIR}"

# Get versions
OLD_VERSION=$(grep '"version"' "${INSTALL_DIR}/.syrviscore-manifest.json" | head -1 | cut -d'"' -f4)
PKG_VERSION=$(grep '^version=' "${SYNOPKG_PKGDEST}/../INFO" | cut -d'"' -f2)

echo "Upgrading from ${OLD_VERSION} to ${PKG_VERSION}"

# === SECTION 1: Create version backup directory ===
BACKUP_DIR="${INSTALL_DIR}/versions/backup-${OLD_VERSION}-$(date +%Y%m%d-%H%M%S)"
mkdir -p "${BACKUP_DIR}"

# Backup manifest and .env
if [ -f "${INSTALL_DIR}/.syrviscore-manifest.json" ]; then
    cp "${INSTALL_DIR}/.syrviscore-manifest.json" "${BACKUP_DIR}/"
fi
if [ -f "${INSTALL_DIR}/.env" ]; then
    cp "${INSTALL_DIR}/.env" "${BACKUP_DIR}/"
fi

# === SECTION 2: Upgrade Python CLI ===
cd "${INSTALL_DIR}/cli"

# Remove old venv
rm -rf venv

# Create new venv
python3 -m venv venv
. venv/bin/activate
pip install --upgrade pip > /dev/null 2>&1
pip install --no-cache-dir "${SYNOPKG_PKGDEST}/package"/syrviscore-*.whl > /dev/null 2>&1
deactivate

# === SECTION 3: Update build configuration ===
cp -r "${SYNOPKG_PKGDEST}/package/build" "${INSTALL_DIR}/"
cp "${SYNOPKG_PKGDEST}/package/.env.template" "${INSTALL_DIR}/"

# === SECTION 4: Preserve .env (DO NOT regenerate) ===
echo "Preserving existing .env configuration"
# .env is preserved - user's configuration stays intact

# === SECTION 5: Update CLI wrapper (if needed) ===
cat > "${INSTALL_DIR}/bin/syrvis" << 'CLI_WRAPPER_EOF'
#!/bin/sh
# SyrvisCore CLI Wrapper
SCRIPT_DIR="$(cd "$(dirname "$0")" && pwd)"
INSTALL_DIR="$(dirname "${SCRIPT_DIR}")"
export SYRVIS_HOME="${INSTALL_DIR}"
exec "${INSTALL_DIR}/cli/venv/bin/syrvis" "$@"
CLI_WRAPPER_EOF
chmod +x "${INSTALL_DIR}/bin/syrvis"

# === SECTION 6: Update manifest ===
INSTALL_DATE=$(grep '"install_date"' "${INSTALL_DIR}/.syrviscore-manifest.json" | cut -d'"' -f4)
INSTALL_VOLUME=$(grep '"install_volume"' "${INSTALL_DIR}/.syrviscore-manifest.json" | cut -d'"' -f4)
NETWORK_INTERFACE=$(grep '"interface"' "${INSTALL_DIR}/.syrviscore-manifest.json" | cut -d'"' -f4)
NETWORK_SUBNET=$(grep '"subnet"' "${INSTALL_DIR}/.syrviscore-manifest.json" | cut -d'"' -f4)
NETWORK_GATEWAY=$(grep '"gateway"' "${INSTALL_DIR}/.syrviscore-manifest.json" | cut -d'"' -f4)
TRAEFIK_IP=$(grep -A 1 '"network"' "${INSTALL_DIR}/.syrviscore-manifest.json" | grep -v '"network"' | grep 'traefik_ip' | cut -d'"' -f4 || echo "")
DOMAIN=$(grep '"domain"' "${INSTALL_DIR}/.syrviscore-manifest.json" | cut -d'"' -f4)
SETUP_COMPLETE=$(grep '"setup_complete"' "${INSTALL_DIR}/.syrviscore-manifest.json" | grep -q 'true' && echo "true" || echo "false")

cat > "${INSTALL_DIR}/.syrviscore-manifest.json" << MANIFEST_EOF
{
    "version": "${PKG_VERSION}",
    "previous_version": "${OLD_VERSION}",
    "install_date": "${INSTALL_DATE}",
    "upgrade_date": "$(date -u +%Y-%m-%dT%H:%M:%SZ)",
    "install_dir": "${INSTALL_DIR}",
    "install_volume": "${INSTALL_VOLUME}",
    "setup_complete": ${SETUP_COMPLETE},
    "network": {
        "interface": "${NETWORK_INTERFACE}",
        "subnet": "${NETWORK_SUBNET}",
        "gateway": "${NETWORK_GATEWAY}",
        "traefik_ip": "${TRAEFIK_IP}"
    },
    "domain": "${DOMAIN}",
    "python_version": "$(python3 --version 2>&1 | awk '{print $2}')"
}
MANIFEST_EOF

# === SECTION 7: Update setup-privileges.py ===
cp "${SYNOPKG_PKGDEST}/package/bin/setup-privileges.py" "${INSTALL_DIR}/bin/"
chmod +x "${INSTALL_DIR}/bin/setup-privileges.py"

# === SECTION 8: Update Task Scheduler template ===
cat > "${INSTALL_DIR}/bin/syrviscore-task-template.json" << 'TASK_TEMPLATE_EOF'
{
  "name": "SyrvisCore - Docker Permissions Setup",
  "owner": {
    "0": {
      "group": "root",
      "user": "root"
    }
  },
  "enable": true,
  "schedule": {
    "date_type": 0,
    "repeat_date": "0",
    "repeat_hour": "0",
    "repeat_min": "0"
  },
  "script": "python3 ${INSTALL_DIR}/bin/setup-privileges.py",
  "extra": {
    "notify_enable": false,
    "notify_mail": "",
    "notify_if_error": false
  },
  "type": "boot"
}
TASK_TEMPLATE_EOF
sed -i "s|\${INSTALL_DIR}|${INSTALL_DIR}|g" "${INSTALL_DIR}/bin/syrviscore-task-template.json"

echo ""
echo "===================================================================="
echo "  SyrvisCore Upgrade Complete: ${OLD_VERSION} â†’ ${PKG_VERSION}"
echo "===================================================================="
echo ""
echo "Configuration backup saved to:"
echo "  ${BACKUP_DIR}"
echo ""
echo "Your existing .env configuration has been preserved."
echo ""
echo "Next steps:"
echo "  1. Review release notes for any breaking changes"
echo "  2. If docker-compose.yaml needs updates, regenerate it:"
echo "     ${INSTALL_DIR}/bin/syrvis compose generate"
echo "  3. Restart services:"
echo "     ${INSTALL_DIR}/bin/syrvis restart"
echo ""
echo "===================================================================="
echo ""

exit 0
