#!/bin/sh
# postupgrade - Upgrade SyrvisCore Manager
# POSIX shell compatible
#
# This script upgrades the MANAGER package only.
# Service versions are managed separately via 'syrvisctl'.

set -e

SCRIPT_NAME="postupgrade"
LOG_FILE="/tmp/syrviscore-install.log"

log_msg() {
    LEVEL="$1"
    MSG="$2"
    TIMESTAMP=$(date '+%Y-%m-%d %H:%M:%S')
    LOG_LINE="[$LEVEL] [$TIMESTAMP] [$SCRIPT_NAME] $MSG"

    if [ "$LEVEL" = "ERROR" ]; then
        echo "$LOG_LINE" >&2
    else
        echo "$LOG_LINE"
    fi

    echo "$LOG_LINE" >> "$LOG_FILE" 2>/dev/null || true
}

log_info() {
    log_msg "INFO" "$1"
}

log_error() {
    log_msg "ERROR" "$1"
}

PACKAGE_NAME="syrviscore"
SYNOPKG_PKGDEST="${SYNOPKG_PKGDEST:-/var/packages/${PACKAGE_NAME}/target}"

log_info "==================================================================="
log_info "Upgrading SyrvisCore Manager"
log_info "==================================================================="
log_info "Target directory: ${SYNOPKG_PKGDEST}"
log_info ""

# === Upgrade manager virtual environment ===
log_info "[1/3] Upgrading manager virtual environment..."

MANAGER_VENV="${SYNOPKG_PKGDEST}/venv"

# Remove old venv
if [ -d "$MANAGER_VENV" ]; then
    rm -rf "$MANAGER_VENV"
    log_info "  Removed old venv"
fi

# Create new venv
python3 -m venv "$MANAGER_VENV"
log_info "  Created new venv"

# Upgrade pip
"${MANAGER_VENV}/bin/pip" install --upgrade pip > /dev/null 2>&1
log_info "  Upgraded pip"

# === Install manager wheel ===
log_info "[2/3] Installing manager package..."

# Find manager wheel
WHEEL_FILE=$(ls "${SYNOPKG_PKGDEST}"/syrviscore_manager-*.whl 2>/dev/null | head -1)

if [ -z "$WHEEL_FILE" ]; then
    # Try package subdirectory
    WHEEL_FILE=$(ls "${SYNOPKG_PKGDEST}/package"/syrviscore_manager-*.whl 2>/dev/null | head -1)
fi

if [ -z "$WHEEL_FILE" ]; then
    log_error "Manager wheel file not found"
    exit 1
fi

log_info "  Found wheel: $(basename "$WHEEL_FILE")"

# Install wheel
"${MANAGER_VENV}/bin/pip" install --no-cache-dir "$WHEEL_FILE" > /dev/null 2>&1
log_info "  Manager package installed"

# Verify installation
if [ ! -f "${MANAGER_VENV}/bin/syrvisctl" ]; then
    log_error "syrvisctl command not found after install"
    exit 1
fi

log_info "  Verified: syrvisctl command available"

# === Update global symlink ===
log_info "[3/3] Updating global symlink..."

SYRVISCTL_LINK="/usr/local/bin/syrvisctl"

mkdir -p /usr/local/bin

if [ -L "$SYRVISCTL_LINK" ] || [ -f "$SYRVISCTL_LINK" ]; then
    rm -f "$SYRVISCTL_LINK"
fi

ln -s "${MANAGER_VENV}/bin/syrvisctl" "$SYRVISCTL_LINK"
log_info "  Updated symlink: ${SYRVISCTL_LINK}"

log_info ""
log_info "==================================================================="
log_info "SyrvisCore Manager Upgrade Complete"
log_info "==================================================================="
log_info ""
log_info "The manager has been upgraded."
log_info ""
log_info "Service versions are not affected by this upgrade."
log_info "To update the service package, run:"
log_info "  syrvisctl install"
log_info ""
log_info "==================================================================="
log_info "Detailed logs: $LOG_FILE"

exit 0
