# SyrvisCore File Structure

This document provides a comprehensive overview of the SyrvisCore project's file structure, explaining the purpose of each directory and important file.

## Project Root

```
SyrvisCore/
├── .clinerules              # AI assistant rules for project conventions
├── .env.template            # Template for local environment variables
├── .gitignore              # Git ignore patterns
├── LICENSE                 # MIT License
├── pyproject.toml          # Python package configuration and dependencies
├── README.md               # Project overview and quick start guide
├── tox.ini                 # Multi-environment testing configuration
├── .github/                # GitHub-specific configuration
├── .vscode/                # VS Code IDE configuration
├── build/                  # Generated build configuration files
├── build-tools/            # Build automation scripts
├── docs/                   # Project documentation
├── spk/                    # Synology Package (SPK) structure
├── src/                    # Python source code
└── tests/                  # Test suite
```

## Core Configuration Files

### pyproject.toml
**Purpose:** Central configuration file for the Python package using modern packaging standards.

**Contains:**
- Package metadata (name, version, description, authors)
- Project dependencies (`[project.dependencies]`)
- Development dependencies (`[project.optional-dependencies.dev]`)
- Build system configuration (setuptools)
- CLI entry points (`[project.scripts]`)
- Tool configurations (Black, Ruff, pytest)

**Key Points:**
- Package name: `syrviscore`
- CLI command: `syrvis`
- All dependencies managed here (no separate requirements.txt)

### .clinerules
**Purpose:** Defines project conventions and guidelines for AI assistants and developers.

**Contains:**
- File naming conventions (`.yaml` vs `.yml`)
- Code style guidelines (Black, Ruff)
- Project structure rules
- Common tasks and commands
- What to avoid (anti-patterns)

### .env.template
**Purpose:** Template for local development environment variables.

**Usage:**
- Copy to `.env` for local development
- Never commit actual `.env` file
- Contains placeholders for sensitive data

## GitHub Configuration (`.github/`)

```
.github/
└── workflows/
    └── test.yml            # CI/CD pipeline for automated testing
```

### workflows/test.yml
**Purpose:** GitHub Actions workflow for continuous integration.

**Triggers:**
- Pull requests
- Pushes to main branch

**Tasks:**
- Run pytest test suite
- Check code formatting with Black
- Run Ruff linting

## VS Code Configuration (`.vscode/`)

```
.vscode/
├── extensions.json         # Recommended VS Code extensions
├── launch.json            # Debug configurations
└── settings.json          # Workspace-specific settings
```

**Purpose:** Standardizes the development environment for team members using VS Code.

## Build System

### build/
```
build/
└── config.yaml            # Docker image versions (ONLY)
```

**Purpose:** Contains generated build configuration files.

**Important:** This directory contains ONLY Docker image versions (Traefik, Portainer, Cloudflared). Python dependencies are in `pyproject.toml`.

### build/config.yaml
**Purpose:** Stores specific Docker image versions for reproducible builds.

**Format:**
```yaml
docker_images:
  traefik: traefik:v2.10.5
  portainer: portainer/portainer-ce:2.19.4
  cloudflared: cloudflare/cloudflared:2024.11.0
```

**Generated by:** `build-tools/select-docker-versions.py`

### build-tools/
```
build-tools/
├── README.md                      # Build tool documentation
├── build-python-package.sh        # Builds Python wheel package
├── build-spk.sh                   # Builds Synology SPK package
├── select-docker-versions.py      # Fetches and selects Docker versions
└── validate-spk.sh                # Validates SPK structure
```

**Purpose:** Automation scripts for building and packaging SyrvisCore.

### build-tools/select-docker-versions.py
**Purpose:** Interactive tool to select Docker image versions from Docker Hub.

**Features:**
- Queries Docker Hub API for available versions
- Presents user-friendly selection interface
- Updates `build/config.yaml` with selected versions
- Ensures reproducible builds

**Usage:**
```bash
./build-tools/select-docker-versions.py
```

### build-tools/build-python-package.sh
**Purpose:** Builds the Python wheel package for the CLI.

**Process:**
1. Cleans previous builds
2. Runs `python -m build` to create wheel
3. Places wheel in `dist/` directory

**Output:** `dist/syrviscore-{version}-py3-none-any.whl`

### build-tools/build-spk.sh
**Purpose:** Assembles the complete Synology SPK package.

**Process:**
1. Validates required files exist
2. Builds Python package
3. Packages SPK structure with all components
4. Creates final `.spk` file

**Output:** `dist/syrviscore-{version}.spk`

### build-tools/validate-spk.sh
**Purpose:** Validates SPK package structure before building.

**Checks:**
- Required files present (INFO, scripts, etc.)
- Proper file permissions
- Valid JSON in wizard files

## Documentation (`docs/`)

```
docs/
├── design-doc.md              # Original project design document
├── design-doc-update-1.md     # Design updates and decisions
├── file-structure.md          # This document
└── spk-installation-guide.md  # SPK installation instructions
```

### docs/design-doc.md
**Purpose:** Comprehensive project design documentation.

**Contains:**
- Project vision and goals
- Architecture decisions
- Technology stack rationale
- Security considerations
- Future roadmap

### docs/design-doc-update-1.md
**Purpose:** Updates to the original design document.

**Contains:**
- Evolved requirements
- Implementation lessons learned
- Updated architecture decisions

### docs/spk-installation-guide.md
**Purpose:** Step-by-step guide for installing the SPK on Synology NAS.

**Covers:**
- Prerequisites
- Installation process
- Configuration steps
- Troubleshooting

## Source Code (`src/`)

```
src/
├── syrviscore/
│   ├── __init__.py            # Package initialization
│   ├── __version__.py         # Version information (single source of truth)
│   ├── cli.py                 # Click-based CLI commands
│   ├── compose.py             # Docker Compose generation
│   ├── docker_manager.py      # Docker container management
│   ├── paths.py               # Path management and validation
│   └── traefik_config.py      # Traefik configuration generation
└── syrviscore.egg-info/       # Generated package metadata (not in git)
```

### src/syrviscore/__version__.py
**Purpose:** Single source of truth for version number.

**Format:**
```python
__version__ = "0.1.0"
```

**Used by:**
- `pyproject.toml` (dynamic version)
- Build scripts
- CLI `--version` flag
- SPK INFO file

### src/syrviscore/cli.py
**Purpose:** Command-line interface built with Click.

**Commands:**
- `syrvis status` - Show service status
- `syrvis logs` - View service logs
- `syrvis config` - Manage configuration
- `syrvis version` - Display version

**Structure:**
- Main `cli()` group function
- Individual command functions with `@cli.command()` decorators
- Help text via docstrings

### src/syrviscore/compose.py
**Purpose:** Generates Docker Compose YAML configurations.

**Functions:**
- `generate_compose()` - Creates complete docker-compose.yaml
- Service definitions for Traefik, Portainer, Cloudflared
- Network and volume configurations
- Dependency management between services

### src/syrviscore/docker_manager.py
**Purpose:** Manages Docker container lifecycle.

**Functions:**
- `start_containers()` - Starts service stack
- `stop_containers()` - Stops service stack
- `restart_containers()` - Restarts services
- `get_container_status()` - Queries container state

**Uses:** Python Docker SDK

### src/syrviscore/paths.py
**Purpose:** Centralized path management for the application.

**Defines:**
- Installation paths (`/volume1/docker/syrviscore/`)
- Configuration paths
- Log paths
- Data volume paths

**Ensures:**
- Path consistency across modules
- Proper permissions
- Directory creation on demand

### src/syrviscore/traefik_config.py
**Purpose:** Generates Traefik reverse proxy configuration.

**Functions:**
- `generate_traefik_yml()` - Static configuration
- `generate_dynamic_config()` - Dynamic routing rules
- SSL/TLS configuration
- Middleware definitions

**Output Format:** YAML configuration files for Traefik

## Tests (`tests/`)

```
tests/
├── test_cli.py                # CLI command tests
├── test_compose.py            # Docker Compose generation tests
├── test_docker_manager.py     # Docker management tests
├── test_paths.py              # Path management tests
└── test_traefik_config.py     # Traefik config generation tests
```

**Purpose:** Pytest-based test suite ensuring code quality.

**Structure:**
- Mirrors source code structure
- `test_*.py` naming convention
- Uses pytest fixtures for setup/teardown

**Running Tests:**
```bash
pytest                    # All tests
pytest tests/test_cli.py  # Specific test file
pytest -v                 # Verbose output
tox                       # Multiple Python versions
```

## Synology Package Structure (`spk/`)

```
spk/
├── INFO                       # Package metadata
├── conf/
│   └── privilege              # Required DSM privileges
├── icons/
│   ├── PACKAGE_ICON.PNG       # 72x72 package icon
│   └── PACKAGE_ICON_256.PNG   # 256x256 package icon
├── package/
│   └── README.md              # Package contents description
├── scripts/
│   ├── postinst              # Post-installation script
│   ├── postuninst            # Post-uninstallation script
│   ├── postupgrade           # Post-upgrade script
│   ├── preinst               # Pre-installation script
│   ├── preuninst             # Pre-uninstallation script
│   ├── preupgrade            # Pre-upgrade script
│   └── start-stop-status     # Service lifecycle management
└── WIZARD_UIFILES/
    └── install_uifile.json   # Installation wizard UI
```

### spk/INFO
**Purpose:** SPK package metadata required by Synology DSM.

**Contains:**
- Package name, version, description
- Architecture compatibility
- DSM version requirements
- Dependencies (e.g., Docker package)
- Maintainer information
- Package size

**Format:** Key-value pairs

### spk/conf/privilege
**Purpose:** Declares required system privileges for the package.

**Format:** JSON
```json
{
  "defaults": {
    "run-as": "package"
  }
}
```

### spk/icons/
**Purpose:** Package icons displayed in DSM Package Center.

**Files:**
- `PACKAGE_ICON.PNG` - 72x72px icon
- `PACKAGE_ICON_256.PNG` - 256x256px icon

**Requirements:**
- PNG format
- Transparent background recommended
- Must follow Synology design guidelines

### spk/scripts/
**Purpose:** Lifecycle scripts executed by DSM during installation, upgrade, and uninstallation.

**Script Execution Order:**

**Installation:**
1. `preinst` - Pre-installation checks and setup
2. Package extraction
3. `postinst` - Post-installation tasks (service setup)

**Upgrade:**
1. `preupgrade` - Pre-upgrade backup and validation
2. Package extraction
3. `postupgrade` - Post-upgrade migration and restart

**Uninstallation:**
1. `preuninst` - Pre-uninstall cleanup preparation
2. Package removal
3. `postuninst` - Complete cleanup (containers, volumes, data)

### spk/scripts/start-stop-status
**Purpose:** Service lifecycle management script for DSM.

**Functions:**
- `start()` - Starts SyrvisCore services
- `stop()` - Stops SyrvisCore services
- `status()` - Returns service status for DSM

**Called by:** DSM Package Manager

### spk/WIZARD_UIFILES/install_uifile.json
**Purpose:** Defines the installation wizard UI in Package Center.

**Contains:**
- Installation steps
- Configuration forms
- User input fields
- Validation rules

**Format:** JSON with DSM-specific structure

## Distribution Files (Not in Git)

```
dist/                          # Generated by build scripts
├── syrviscore-{version}-py3-none-any.whl  # Python wheel
└── syrviscore-{version}.spk               # Synology package
```

**Purpose:** Build artifacts ready for distribution.

**Generated by:**
- `build-tools/build-python-package.sh` (creates `.whl`)
- `build-tools/build-spk.sh` (creates `.spk`)

**Not in Git:** These are build artifacts and should be generated fresh for each release.

## Important Relationships

### Dependency Flow
```
User installs SPK
    ↓
postinst runs
    ↓
Installs Python wheel
    ↓
syrvis CLI available
    ↓
Generates configs (Traefik, Compose)
    ↓
Starts Docker containers
```

### Version Flow
```
src/syrviscore/__version__.py
    ↓
pyproject.toml (dynamic)
    ↓
build-python-package.sh
    ↓
dist/syrviscore-{version}.whl
    ↓
spk/INFO (updated during build)
    ↓
dist/syrviscore-{version}.spk
```

### Configuration Flow
```
build/config.yaml (Docker versions)
    ↓
src/syrviscore/compose.py (reads versions)
    ↓
Generates docker-compose.yaml
    ↓
Deploys to /volume1/docker/syrviscore/
```

## Key Design Decisions

### Why This Structure?

1. **Separation of Concerns:**
   - Source code (`src/`) separate from packaging (`spk/`)
   - Build tools (`build-tools/`) separate from generated config (`build/`)
   - Tests (`tests/`) mirror source structure

2. **Standard Python Packaging:**
   - `pyproject.toml` as single source of truth for Python dependencies
   - Follows PEP 517/518 modern packaging standards
   - Enables `pip install -e .` for development

3. **Reproducible Builds:**
   - Pinned Docker versions in `build/config.yaml`
   - Versioned Python dependencies in `pyproject.toml`
   - Automated build scripts in `build-tools/`

4. **Synology Integration:**
   - Complete SPK structure in `spk/` directory
   - Lifecycle scripts for DSM integration
   - Privilege configuration for security

5. **Developer Experience:**
   - VS Code configuration for consistency
   - AI assistant rules (`.clinerules`)
   - Comprehensive documentation in `docs/`
   - Clear separation between development and production

## Navigation Tips

- **Starting development?** Read `README.md` then `docs/design-doc.md`
- **Building the project?** Check `build-tools/README.md`
- **Installing on Synology?** See `docs/spk-installation-guide.md`
- **Understanding architecture?** Review `docs/design-doc.md`
- **Adding features?** Start in `src/syrviscore/` and add tests in `tests/`
- **Modifying SPK?** Work in `spk/` directory and validate with `validate-spk.sh`

## File Naming Conventions

- **YAML files:** Use `.yaml` extension (except GitHub Actions)
- **GitHub Actions:** Use `.yml` extension (GitHub convention)
- **Python files:** Use `snake_case`
- **Test files:** Prefix with `test_` to match source file names
- **Documentation:** Use kebab-case (e.g., `file-structure.md`)

## What's Not in Git

The following are generated and should not be committed:

- `dist/` - Build artifacts (wheels, SPK files)
- `src/syrviscore.egg-info/` - Python packaging metadata
- `*.pyc`, `__pycache__/` - Python bytecode
- `.env` - Local environment variables (use `.env.template`)
- `venv/`, `.venv/` - Virtual environments
- `.DS_Store` - macOS metadata
- `*.spk` - Built Synology packages
- `*.whl` - Built Python wheels

## Future Additions

As the project evolves, expect these additions:

- `src/syrviscore/web/` - Web UI (Phase 2)
- `src/syrviscore/catalog/` - Stack catalog system
- `docs/api/` - API documentation
- `examples/` - Usage examples
- `scripts/` - Utility scripts for development

## Getting Help

- **File structure questions?** This document
- **Build issues?** Check `build-tools/README.md`
- **Installation problems?** See `docs/spk-installation-guide.md`
- **Design decisions?** Read `docs/design-doc.md`
- **Contributing?** Review `.clinerules` and `README.md`
