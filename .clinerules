# Cline Rules for SyrvisCore Project

## Project Overview
SyrvisCore is a self-hosted infrastructure platform for Synology NAS that packages Traefik (reverse proxy), Portainer (container management), and Cloudflared (tunnel) into a single SPK package. The project uses modern Python packaging with a CLI built on Click.

## Core Principles

### Python Packaging
- Use `pyproject.toml` for ALL dependency management (no separate requirements.txt)
- Package dependencies go in `[project.dependencies]`
- Development/testing dependencies go in `[project.optional-dependencies.dev]`
- Never manually pip install packages - they should be in pyproject.toml
- Use editable installs: `pip install -e .` or `pip install -e ".[dev]"`
- Python package name: `syrviscore` (lowercase, no hyphen)
- CLI command name: `syrvis`

### File Naming Conventions
- YAML files: Use `.yaml` extension (not `.yml`) except for GitHub Actions
- GitHub Actions: Use `.yml` extension (follows GitHub convention)
- Python files: Use snake_case
- Prefer descriptive names over abbreviations

### Code Style
- Use Black for formatting (line length: 100)
- Use Ruff for linting
- Type hints encouraged but not required for MVP
- Docstrings for public functions using Google style
- CLI help text should be clear and user-friendly

### Build System
- `build/config.yaml` contains ONLY Docker image versions (Traefik, Portainer, Cloudflared)
- Python dependencies managed via pyproject.toml, NOT build/config.yaml
- Build tools in `build-tools/` directory
- Build tools should be standalone Python scripts with shebang
- Generated artifacts go in `dist/` (SPK files) or `build/` (intermediate files)

### Version Management
- Follow semantic versioning (MAJOR.MINOR.PATCH)
- Version defined in `src/syrviscore/__version__.py`
- Keep version DRY - single source of truth

### Project Structure
```
SyrvisCore/
‚îú‚îÄ‚îÄ .github/workflows/       # CI/CD (use .yml extension)
‚îú‚îÄ‚îÄ .vscode/                 # VS Code config
‚îú‚îÄ‚îÄ src/syrviscore/          # Main package
‚îÇ   ‚îú‚îÄ‚îÄ __init__.py
‚îÇ   ‚îú‚îÄ‚îÄ __version__.py       # Version info
‚îÇ   ‚îî‚îÄ‚îÄ cli.py               # CLI entry point
‚îú‚îÄ‚îÄ tests/                   # Pytest tests
‚îú‚îÄ‚îÄ build-tools/             # Build utilities
‚îÇ   ‚îî‚îÄ‚îÄ select-docker-versions
‚îú‚îÄ‚îÄ build/                   # Generated build configs
‚îÇ   ‚îî‚îÄ‚îÄ config.yaml          # Docker versions ONLY
‚îú‚îÄ‚îÄ docs/                    # Documentation
‚îú‚îÄ‚îÄ pyproject.toml           # Package config & dependencies
‚îú‚îÄ‚îÄ tox.ini                  # Multi-env testing (optional)
‚îú‚îÄ‚îÄ README.md
‚îî‚îÄ‚îÄ .gitignore
```

### Git Practices
- Keep commits atomic and well-described
- Don't commit secrets (.env files)
- Don't commit venv/ or __pycache__/
- Don't commit build artifacts (*.spk, dist/)
- DO commit build/config.yaml (it's versioned Docker tags)

### Testing
- Use pytest for testing
- Tests go in `tests/` directory
- Mirror source structure in tests (tests/test_cli.py for src/syrviscore/cli.py)
- Run tests with `pytest` or `tox`

### Documentation
- User-facing docs in `docs/` directory
- API docs via docstrings
- README.md should have quick start, not comprehensive docs
- Keep design doc (design-doc.md) updated with major decisions

### Synology-Specific
- Target DSM 7.0+
- Package filename: `syrviscore-{version}.spk`
- Installation path: `/volume1/docker/syrviscore/`
- User service account: `syrvis-bot`
- Requires Docker package on Synology

### SPK Script Logging Standards

All SPK scripts must implement consistent, structured logging for troubleshooting.

**Scripts that require logging:**
- `spk/scripts/preinst`
- `spk/scripts/postinst`
- `spk/scripts/preuninst`
- `spk/scripts/postuninst`
- `spk/scripts/preupgrade`
- `spk/scripts/postupgrade`
- `spk/scripts/start-stop-status`

**Logging Function Template** (POSIX-compatible, inline in each script):
```bash
SCRIPT_NAME="preinst"  # Or postinst, preuninst, etc.
LOG_FILE="/tmp/syrviscore-install.log"

log_msg() {
    LEVEL="$1"
    MSG="$2"
    TIMESTAMP=$(date '+%Y-%m-%d %H:%M:%S')
    LOG_LINE="[$LEVEL] [$TIMESTAMP] [$SCRIPT_NAME] $MSG"
    
    if [ "$LEVEL" = "ERROR" ]; then
        echo "$LOG_LINE" >&2
    else
        echo "$LOG_LINE"
    fi
    
    echo "$LOG_LINE" >> "$LOG_FILE" 2>/dev/null || true
}

log_info() {
    log_msg "INFO" "$1"
}

log_warn() {
    log_msg "WARN" "$1"
}

log_error() {
    log_msg "ERROR" "$1"
}
```

**Every script must:**
1. **Start with context:**
   - Log script name and purpose
   - Log working directory
   - Log key environment variables (SYNOPKG_PKGDEST, INSTALL_DIR, wizard vars)

2. **Use step numbering:**
   - Format: `[X/Y] Step description...`
   - Example: `log_info "[1/9] Creating directory structure..."`

3. **Log all operations:**
   - File/directory creation: `log_info "  Created: /path/to/file"`
   - File operations: `log_info "  Copied: source ‚Üí destination"`
   - Command execution: Log before and after with results
   - Permissions: `log_info "  Permissions: 600"`

4. **Log success/failure:**
   - Success: `log_info "  Operation completed successfully"`
   - Warnings: `log_warn "  Non-fatal issue occurred"`
   - Errors: `log_error "  Operation failed: reason"`

5. **End with summary:**
   - Log completion status
   - Show log file location: `log_info "Detailed logs: $LOG_FILE"`

**Log Levels:**
- `log_info` - Normal operations, progress updates
- `log_warn` - Non-fatal issues, warnings, skipped operations
- `log_error` - Failures that cause or should cause exit

**Log File Location:**
- Installation/uninstallation: `/tmp/syrviscore-install.log`
- Persists across install/uninstall for debugging
- Cleared on system reboot (standard /tmp behavior)

**Security:**
- ‚ùå Never log passwords, API keys, tokens in full
- ‚úÖ Log presence of credentials: `log_info "  Cloudflare token: ${token:+<set>}"`
- ‚úÖ Mask sensitive data: Show first/last 4 chars only

**Example Usage:**
```bash
log_info "==================================================================="
log_info "Starting SyrvisCore installation"
log_info "==================================================================="
log_info "Installation parameters:"
log_info "  INSTALL_DIR: $INSTALL_DIR"
log_info "[1/3] Creating directory structure..."
if mkdir -p "$INSTALL_DIR/data"; then
    log_info "  Created: $INSTALL_DIR/data"
else
    log_error "  Failed to create directory"
    log_info "Detailed logs: $LOG_FILE"
    exit 1
fi
log_info "[2/3] Installing Python CLI..."
# ... operations ...
log_info "==================================================================="
log_info "Installation completed successfully"
log_info "Detailed logs: $LOG_FILE"
```

**Benefits:**
- Easier debugging of installation failures
- Chronological tracking of operations
- Persistent logs for post-mortem analysis
- Clear identification of which script failed and where

### Security
- Secrets go in `/volume1/secrets/` on Synology
- Use `.env` files for local secrets (never commit)
- Provide `.env.template` as reference
- SSH keys for GitHub deployment

### External Dependencies
- Traefik - reverse proxy with SSL termination
- Portainer - container management UI
- Cloudflared - Cloudflare Tunnel (optional)
- All Docker images use specific version tags (no :latest)

## Common Tasks

### Adding a CLI Command
1. Add function to `src/syrviscore/cli.py` with `@cli.command()` decorator
2. Use Click decorators for options/arguments
3. Add docstring for help text
4. Test with `syrvis <command>`

### Adding a Dependency
1. Add to `pyproject.toml` under `[project.dependencies]`
2. Reinstall: `pip install -e .`
3. Update if needed for specific version constraint

### Creating a New Build Tool
1. Create executable Python script in `build-tools/`
2. Add shebang: `#!/usr/bin/env python3`
3. Make executable: `chmod +x`
4. Document in `build-tools/README.md`
5. Use argparse for CLI arguments

### Running Tests
```bash
pytest                    # Run all tests
pytest tests/test_cli.py  # Run specific test
pytest -v                 # Verbose output
tox                       # Test all Python versions
```

## What to Avoid

- ‚ùå Don't use `requirements.txt` - use `pyproject.toml`
- ‚ùå Don't put Python packages in `build/config.yaml`
- ‚ùå Don't use `setup.py` - use `pyproject.toml`
- ‚ùå Don't hardcode version strings (use __version__.py)
- ‚ùå Don't use `:latest` tags for Docker images
- ‚ùå Don't commit sensitive data (API keys, passwords, etc.)
- ‚ùå Don't use `sudo pip install` - use venv
- ‚ùå Don't mix tabs and spaces (use spaces)

## Project-Specific Reminders

### This is NOT a web service
- No Flask/FastAPI/Django
- CLI-first design
- Optional web UI is future enhancement

### This is NOT Kubernetes
- Single-node deployment
- Docker Compose for orchestration
- Simple is better than complex

### Build System Philosophy
- Reproducible builds via version pinning
- Clear separation: build-time vs runtime dependencies
- Docker versions frozen in build/config.yaml
- Python dependencies frozen in pyproject.toml

### Community-First Design
- No hardcoded personal info
- Configuration-driven from day one
- Clear documentation for newcomers
- MIT License - permissive and friendly

## AI Assistant Guidelines

When helping with this project:
1. Always check pyproject.toml for existing dependencies before suggesting pip install
2. Prefer adding new dependencies to pyproject.toml over manual installation
3. Follow the file structure and naming conventions above
4. Keep code simple and readable (target audience: technical home users, not enterprise devs)
5. When suggesting commands, assume venv is already activated
6. Reference the design doc (docs/design-doc.md) for architecture decisions
7. Suggest tests for new functionality
8. Keep security in mind (secrets handling, file permissions)

## Task Summary Format

When creating end-of-session summaries, keep them **concise and scannable**:

**Maximum Length:** 20 lines total (not including the template structure)

**Required Structure:**
```
## Task: [One-line description]

### Completed
- [3-5 bullet points maximum - high-level accomplishments only]

### Key Files Changed
- [2-4 most important files/directories only]

### Next Steps
- [2-3 immediate action items]

### Issues/Notes (optional)
- [Critical issues only - omit if none]
```

**What to Include:**
- ‚úÖ High-level accomplishments (what was built/fixed)
- ‚úÖ Most important file changes only
- ‚úÖ Concrete next steps for user
- ‚úÖ Critical issues that block progress

**What to Omit:**
- ‚ùå Detailed file listings (user can see git status)
- ‚ùå Verbose explanations already discussed during session
- ‚ùå Full success criteria checklists (just state "all criteria met" or list failures)
- ‚ùå Repeating task requirements from prompt
- ‚ùå Implementation details (user was present for the work)
- ‚ùå Celebratory language or filler text

**Example - Good Summary:**
```
## Task: Migrate to Standard Python Packaging

### Completed
- Replaced custom tarballs with standard Python wheels
- SPK now uses `pip install` for CLI installation
- Fixed all hardcoded IP addresses (192.168.8.x ‚Üí 192.168.0.x)

### Key Files Changed
- build-tools/build-python-package.sh (new)
- spk/scripts/postinst (simplified)
- All scripts/*.sh (generic IPs)

### Next Steps
- Test SPK installation on Synology NAS
- Create GitHub Actions workflow for automated builds
```

**Example - Bad Summary (too verbose):**
```
## Task: SPK Development - Phase 1 Complete! üéâ

Successfully created a complete, production-ready SPK package...
[50+ lines of detailed explanations, file listings, and repeated information]
```

The goal is a **quick scan** that tells the user what changed and what to do next.

## Current Phase: MVP (Phase 1)

Focus areas:
- Build system (select-docker-versions, build-spk)
- Basic CLI commands (status, logs, version, config)
- SPK package structure
- Installation/upgrade scripts

NOT in scope yet:
- Web UI
- Auto-updates
- Stack catalog
- Extensive monitoring

## Resources

- Design Doc: `docs/design-doc.md`
- Docker Hub API: https://hub.docker.com/v2/
- Click docs: https://click.palletsprojects.com/
- Python packaging: https://packaging.python.org/
- Synology DSM: https://www.synology.com/en-us/dsm
